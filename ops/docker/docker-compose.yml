x-api-base: &api-base
  image: fxrates:dev
  depends_on:
    postgres:
      condition: service_healthy
  environment: &api-base-env
    PORT: "8080"
    STORAGE: "pg"
    DATABASE_URL: "postgres://postgres:postgres@postgres:5432/fxrates?sslmode=disable"
    LOG_LEVEL: "info"
    REDIS_ADDR: ${REDIS_ADDR}
    REQUEST_TIMEOUT_MS: "3000"
  ports:
    - "8080:8080"

x-worker-base: &worker-base
  image: fxrates:dev
  depends_on:
    postgres:
      condition: service_healthy
  entrypoint: ["/usr/local/bin/worker"]
  environment: &worker-base-env
    STORAGE: "pg"
    DATABASE_URL: "postgres://postgres:postgres@postgres:5432/fxrates?sslmode=disable"
    PROVIDER: ${PROVIDER}
    EXCHANGE_API_BASE: ${EXCHANGE_API_BASE}
    EXCHANGE_API_KEY: ${EXCHANGE_API_KEY}
    REDIS_ADDR: ${REDIS_ADDR}
    WORKER_POLL_MS: "250"
    WORKER_BATCH_LIMIT: "10"

services:
  postgres:
    image: postgres:17
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: fxrates
    ports:
      - "5431:5431"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d fxrates"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # chan profile: API only (in-process worker)
  api-chan:
    <<: *api-base
    profiles: ["chan"]
    environment:
      <<: *api-base-env
      WORKER_TYPE: "chan"

  # db profile: API + DB polling workers
  api-db:
    <<: *api-base
    profiles: ["db"]
    environment:
      <<: *api-base-env
      WORKER_TYPE: "db"

  worker-db:
    <<: *worker-base
    profiles: ["db"]
    environment:
      <<: *worker-base-env
      WORKER_TYPE: "db"
    deploy:
      replicas: 3

  # grpc profile: API + gRPC workers
  api-grpc:
    <<: *api-base
    profiles: ["grpc"]
    environment:
      <<: *api-base-env
      WORKER_TYPE: "grpc"
      GRPC_TARGET: "dns:///worker-grpc:9090"

  worker-grpc:
    <<: *worker-base
    profiles: ["grpc"]
    environment:
      <<: *worker-base-env
      WORKER_TYPE: "grpc"
      GRPC_ADDR: ":9090"
    deploy:
      replicas: 3

